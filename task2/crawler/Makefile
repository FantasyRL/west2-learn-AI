DIR=$(shell pwd)
GEN_CONFIG_PATH=$(DIR)/pkg/sql-gen/config.yaml

# ç”Ÿæˆ Protobuf API ä»£ç 
.PHONY: proto
proto:
	@echo "ğŸš€ ç”Ÿæˆ Protobuf API ä»£ç ..."
	@mkdir -p api/generated
	python -m grpc_tools.protoc \
		-I./idl \
		--python_out=./api/generated \
		--grpc_python_out=./api/generated \
		--pyi_out=./api/generated \
		./idl/crawler.proto
	@echo "âœ… Protobuf ä»£ç ç”Ÿæˆå®Œæˆï¼"
	@echo "ğŸ“ è¾“å‡ºç›®å½•: api/generated/"

# ç”Ÿæˆæ•°æ®åº“æ¨¡å‹
.PHONY: model
model:
	@echo "ğŸš€ ç”Ÿæˆæ•°æ®åº“æ¨¡å‹..."
	python pkg/sql-gen/main.py --config $(GEN_CONFIG_PATH)
	@echo "ğŸ“ è¾“å‡ºç›®å½•: pkg/sql-gen/generated_models/"
	@echo "ğŸ’¡ æç¤º: è¯·æ‰‹åŠ¨å¤åˆ¶æ¨¡å‹åˆ° models/ ç›®å½•"

# åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“è¡¨
.PHONY: list-tables
list-tables:
	@echo "ğŸ“Š æ•°æ®åº“è¡¨åˆ—è¡¨:"
	python pkg/sql-gen/main.py --config $(GEN_CONFIG_PATH) --list-tables

# ç”ŸæˆæŒ‡å®šè¡¨çš„æ¨¡å‹
# ä½¿ç”¨æ–¹å¼: make model-table TABLES="table1 table2"
.PHONY: model-table
model-table:
	@echo "ğŸš€ ç”ŸæˆæŒ‡å®šè¡¨çš„æ¨¡å‹..."
	python pkg/sql-gen/main.py --config $(GEN_CONFIG_PATH) -t $(TABLES)

# ç”Ÿæˆæ‰€æœ‰ä»£ç ï¼ˆAPI + æ¨¡å‹ï¼‰
.PHONY: gen
gen: proto model
	@echo ""
	@echo "âœ… æ‰€æœ‰ä»£ç ç”Ÿæˆå®Œæˆï¼"
	@echo ""
	@echo "ä¸‹ä¸€æ­¥æ“ä½œ:"
	@echo "  1. æŸ¥çœ‹ç”Ÿæˆçš„ API ä»£ç : ls api/generated/"
	@echo "  2. æŸ¥çœ‹ç”Ÿæˆçš„æ¨¡å‹: ls pkg/sql-gen/generated_models/"
	@echo "  3. å¤åˆ¶æ¨¡å‹åˆ°é¡¹ç›®: cp pkg/sql-gen/generated_models/*.py models/"

# æ¸…ç†ç”Ÿæˆçš„ä»£ç 
.PHONY: clean-gen
clean-gen:
	@echo "ğŸ§¹ æ¸…ç†ç”Ÿæˆçš„ä»£ç ..."
	rm -rf api/generated/*
	rm -rf pkg/sql-gen/generated_models/*
	@echo "âœ… æ¸…ç†å®Œæˆï¼"

# å¸®åŠ©ä¿¡æ¯
.PHONY: help
help:
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make proto          - ç”Ÿæˆ Protobuf API ä»£ç "
	@echo "  make model          - ç”Ÿæˆæ‰€æœ‰æ•°æ®åº“æ¨¡å‹"
	@echo "  make list-tables    - åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“è¡¨"
	@echo "  make model-table    - ç”ŸæˆæŒ‡å®šè¡¨çš„æ¨¡å‹ (TABLES='table1 table2')"
	@echo "  make gen            - ç”Ÿæˆæ‰€æœ‰ä»£ç  (API + æ¨¡å‹)"
	@echo "  make clean-gen      - æ¸…ç†ç”Ÿæˆçš„ä»£ç "
	@echo "  make help           - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"